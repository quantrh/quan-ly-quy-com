<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lấy dữ liệu GPS từ Strava</title>
    <!-- Thêm thư viện Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <!-- Thêm thư viện D3.js cho đồ thị -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        h1 {
            color: #FC4C02;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            background-color: #FC4C02;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .btn:hover {
            background-color: #E34402;
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #activityList {
            margin-top: 20px;
        }
        
        .activity-item {
            background-color: white;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .activity-item h3 {
            margin-top: 0;
            color: #FC4C02;
        }
        
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .error {
            background-color: #ffeeee;
            color: #d32f2f;
        }
        
        .success {
            background-color: #eeffee;
            color: #388e3c;
        }
        
        .hidden {
            display: none;
        }
        
        /* Thêm kiểu cho bản đồ */
        .map-container {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 400px;
            width: 100%;
        }
        
        .activity-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .activity-info-item {
            flex: 1 0 30%;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Thêm kiểu cho biểu đồ hoạt động hàng năm */
        #yearlyActivityChart {
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        
        .chart-tooltip {
            position: absolute;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
        }
        
        .day-label {
            font-size: 12px;
            fill: #666;
            text-anchor: middle;
        }
        
        .week-label {
            font-size: 10px;
            fill: #999;
            text-anchor: end;
        }
        
        .month-label {
            font-size: 12px;
            fill: #666;
            text-anchor: start;
        }
        
        .legend {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Lấy dữ liệu GPS từ Strava</h1>
    
    <div class="container">
        <p>Ứng dụng này cho phép bạn kết nối với tài khoản Strava của mình và tải về dữ liệu GPS từ các hoạt động của bạn.</p>
        
        <div id="statusMessage" class="status hidden"></div>
        
        <div id="authSection">
            <p>Bước 1: Kết nối với tài khoản Strava của bạn.</p>
            <button id="authorizeBtn" class="btn">Kết nối với Strava</button>
        </div>
        
        <div id="activitiesSection" class="hidden">
            <p>Bước 2: Lấy danh sách hoạt động gần đây của bạn.</p>
            <button id="getActivitiesBtn" class="btn">Lấy danh sách hoạt động</button>
            
            <div id="activityList"></div>
        </div>
        
        <div id="yearlyChartSection" class="hidden">
            <h3>Biểu đồ hoạt động trong năm</h3>
            <p>Biểu đồ dưới đây thể hiện tổng số km chạy trong từng ngày trong năm qua. Kích thước vòng tròn tỷ lệ thuận với quãng đường.</p>
            
            <div id="yearlyActivityChart">
                <div id="chartControls">
                    <label for="yearSelect">Chọn năm: </label>
                    <select id="yearSelect" class="btn" style="padding: 5px 10px;">
                        <!-- Năm sẽ được thêm vào bằng JavaScript -->
                    </select>
                    <button id="refreshYearlyChartBtn" class="btn">Cập nhật biểu đồ</button>
                </div>
                <div class="chart-container" id="activityHeatmap"></div>
            </div>
            
            <button id="backToListFromChartBtn" class="btn" style="margin-top: 20px;">Quay lại danh sách</button>
        </div>
        
        <div id="activityDetailSection" class="hidden">
            <div id="activityDetailContainer"></div>
            
            <div class="tabs">
                <div class="tab active" data-tab="map">Bản đồ</div>
                <div class="tab" data-tab="details">Chi tiết</div>
                <div class="tab" data-tab="raw">Dữ liệu</div>
            </div>
            
            <div class="tab-content active" id="mapTab">
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="tab-content" id="detailsTab">
                <div id="activityStats"></div>
            </div>
            
            <div class="tab-content" id="rawTab">
                <div id="activityRawData"></div>
            </div>
            
            <button id="backToListBtn" class="btn" style="margin-top: 20px;">Quay lại danh sách</button>
        </div>
    </div>
    
    <script>
        // Cấu hình ứng dụng Strava
        const clientId = '55949'; // Thay thế bằng Client ID của bạn từ Strava API
        const redirectUri = "https://quantrh.github.io/quan-ly-quy-com/strava_APIold.html";
        
        // Các phần tử DOM
        const authorizeBtn = document.getElementById('authorizeBtn');
        const getActivitiesBtn = document.getElementById('getActivitiesBtn');
        const activityList = document.getElementById('activityList');
        const authSection = document.getElementById('authSection');
        const activitiesSection = document.getElementById('activitiesSection');
        const activityDetailSection = document.getElementById('activityDetailSection');
        const yearlyChartSection = document.getElementById('yearlyChartSection');
        const activityDetailContainer = document.getElementById('activityDetailContainer');
        const activityStats = document.getElementById('activityStats');
        const activityRawData = document.getElementById('activityRawData');
        const backToListBtn = document.getElementById('backToListBtn');
        const backToListFromChartBtn = document.getElementById('backToListFromChartBtn');
        const refreshYearlyChartBtn = document.getElementById('refreshYearlyChartBtn');
        const yearSelect = document.getElementById('yearSelect');
        const statusMessage = document.getElementById('statusMessage');
        
        // Biến lưu trữ
        let accessToken = null;
        let map = null;
        let currentActivityData = null;
        let yearlyActivities = [];
        
        // Xử lý khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra nếu có mã xác thực từ Strava sau khi redirect
            const urlParams = new URLSearchParams(window.location.search);
            const authorizationCode = urlParams.get('code');
            
            if (authorizationCode) {
                // Đã nhận được mã xác thực, tiến hành lấy access token
                showStatus('Đang xác thực với Strava...', 'success');
                exchangeCodeForToken(authorizationCode);
            }
            
            // Thiết lập sự kiện tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Xóa lớp active từ tất cả các tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Thêm lớp active vào tab được nhấp
                    this.classList.add('active');
                    
                    // Hiển thị nội dung tab tương ứng
                    const tabId = this.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Thiết lập sự kiện nút quay lại
            backToListBtn.addEventListener('click', function() {
                activityDetailSection.classList.add('hidden');
                activitiesSection.classList.remove('hidden');
            });
            
            // Thiết lập sự kiện nút quay lại từ biểu đồ năm
            backToListFromChartBtn.addEventListener('click', function() {
                yearlyChartSection.classList.add('hidden');
                activitiesSection.classList.remove('hidden');
            });
            
            // Thiết lập sự kiện nút cập nhật biểu đồ
            refreshYearlyChartBtn.addEventListener('click', function() {
                const selectedYear = yearSelect.value;
                fetchYearlyActivities(selectedYear);
            });
            
            // Khởi tạo danh sách năm
            initYearSelect();
        });
        
        // Khởi tạo danh sách năm cho dropdown
        function initYearSelect() {
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        
        // Sự kiện nút kết nối với Strava
        authorizeBtn.addEventListener('click', function() {
            const scope = 'read,activity:read';
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}`;
            window.location.href = authUrl;
        });
        
        // Sự kiện nút lấy danh sách hoạt động
        getActivitiesBtn.addEventListener('click', function() {
            if (accessToken) {
                getActivities();
            } else {
                showStatus('Vui lòng kết nối với Strava trước', 'error');
            }
        });
        
        // Trao đổi mã xác thực lấy access token
        function exchangeCodeForToken(code) {
            const tokenUrl = 'https://www.strava.com/oauth/token';
            const data = {
                client_id: clientId,
                client_secret: 'c710bdd65acd66b7ce99db734e9850f04bb5ad83', // Thay thế bằng Client Secret của bạn
                code: code,
                grant_type: 'authorization_code'
            };
            
            fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(tokenData => {
                accessToken = tokenData.access_token;
                showStatus('Đã kết nối thành công với Strava!', 'success');
                
                // Hiển thị phần lấy hoạt động
                authSection.classList.add('hidden');
                activitiesSection.classList.remove('hidden');
            })
            .catch(error => {
                showStatus('Lỗi khi xác thực: ' + error.message, 'error');
                console.error('Error exchanging token:', error);
            });
        }
        
        // Lấy danh sách hoạt động
        function getActivities() {
            showStatus('Đang tải danh sách hoạt động...', 'success');
            
            fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(activities => {
                showStatus('Đã tải danh sách hoạt động thành công!', 'success');
                displayActivities(activities);
                
                // Thêm nút để xem biểu đồ hoạt động năm
                const viewYearlyChartBtn = document.createElement('button');
                viewYearlyChartBtn.className = 'btn';
                viewYearlyChartBtn.textContent = 'Xem biểu đồ hoạt động năm';
                viewYearlyChartBtn.style.marginTop = '20px';
                viewYearlyChartBtn.style.display = 'block';
                viewYearlyChartBtn.style.width = '100%';
                
                viewYearlyChartBtn.addEventListener('click', function() {
                    activitiesSection.classList.add('hidden');
                    yearlyChartSection.classList.remove('hidden');
                    
                    // Tải dữ liệu cho năm được chọn
                    const selectedYear = yearSelect.value;
                    fetchYearlyActivities(selectedYear);
                });
                
                activityList.appendChild(viewYearlyChartBtn);
            })
            .catch(error => {
                showStatus('Lỗi khi tải hoạt động: ' + error.message, 'error');
                console.error('Error fetching activities:', error);
            });
        }
        
        // Hiển thị danh sách hoạt động
        function displayActivities(activities) {
            activityList.innerHTML = '';
            
            if (activities.length === 0) {
                activityList.innerHTML = '<p>Không tìm thấy hoạt động nào.</p>';
                return;
            }
            
            activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const date = new Date(activity.start_date).toLocaleDateString('vi-VN');
                
                activityItem.innerHTML = `
                    <h3>${activity.name}</h3>
                    <div class="activity-info">
                        <div class="activity-info-item">
                            <strong>Ngày:</strong> ${date}
                        </div>
                        <div class="activity-info-item">
                            <strong>Loại:</strong> ${activity.type}
                        </div>
                        <div class="activity-info-item">
                            <strong>Quãng đường:</strong> ${(activity.distance / 1000).toFixed(2)} km
                        </div>
                        <div class="activity-info-item">
                            <strong>Thời gian:</strong> ${formatDuration(activity.moving_time)}
                        </div>
                        <div class="activity-info-item">
                            <strong>Tốc độ trung bình:</strong> ${(activity.average_speed * 3.6).toFixed(2)} km/h
                        </div>
                    </div>
                    <button class="btn view-map" data-id="${activity.id}">Xem bản đồ</button>
                    <button class="btn download-gpx" data-id="${activity.id}">Tải GPX</button>
                `;
                
                activityList.appendChild(activityItem);
            });
            
            // Thêm sự kiện cho các nút xem bản đồ
            document.querySelectorAll('.view-map').forEach(button => {
                button.addEventListener('click', function() {
                    const activityId = this.getAttribute('data-id');
                    viewActivityMap(activityId);
                });
            });
            
            // Thêm sự kiện cho các nút tải GPX
            document.querySelectorAll('.download-gpx').forEach(button => {
                button.addEventListener('click', function() {
                    const activityId = this.getAttribute('data-id');
                    downloadGpx(activityId);
                });
            });
        }
        
        // Lấy dữ liệu hoạt động trong một năm
        function fetchYearlyActivities(year) {
            showStatus('Đang tải dữ liệu hoạt động năm ' + year + '...', 'success');
            
            // Tính thời gian bắt đầu và kết thúc của năm (Unix timestamp)
            const startDate = new Date(year, 0, 1).getTime() / 1000; // 1/1/year
            const endDate = new Date(parseInt(year) + 1, 0, 1).getTime() / 1000; // 1/1/year+1
            
            // Gọi API để lấy tất cả hoạt động trong năm
            // Lưu ý: API Strava giới hạn 200 hoạt động mỗi trang, có thể cần phân trang nếu có nhiều hoạt động
            fetch(`https://www.strava.com/api/v3/athlete/activities?after=${startDate}&before=${endDate}&per_page=200`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(activities => {
                yearlyActivities = activities;
                showStatus(`Đã tải ${activities.length} hoạt động trong năm ${year}!`, 'success');
                
                // Lọc các hoạt động chạy bộ hoặc đạp xe (tuỳ theo nhu cầu)
                const runActivities = activities.filter(activity => activity.type === 'Run' || activity.type === 'Ride');
                
                // Hiển thị biểu đồ hoạt động năm
                renderYearlyActivityChart(runActivities, year);
            })
            .catch(error => {
                showStatus('Lỗi khi tải dữ liệu năm: ' + error.message, 'error');
                console.error('Error fetching yearly activities:', error);
            });
        }
        
        // Hiển thị biểu đồ hoạt động năm
        function renderYearlyActivityChart(activities, year) {
            // Xóa biểu đồ cũ nếu có
            d3.select('#activityHeatmap').selectAll('*').remove();
            
            if (activities.length === 0) {
                d3.select('#activityHeatmap').append('p')
                    .text('Không có dữ liệu hoạt động chạy bộ hoặc đạp xe trong năm ' + year);
                return;
            }
            
            // Chuẩn bị dữ liệu
            // Tạo một đối tượng lưu trữ dữ liệu theo ngày
            const dailyData = {};
            activities.forEach(activity => {
                const date = new Date(activity.start_date);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                if (!dailyData[dateStr]) {
                    dailyData[dateStr] = {
                        date: dateStr,
                        distance: 0,
                        activities: []
                    };
                }
                
                dailyData[dateStr].distance += activity.distance / 1000; // Chuyển từ m sang km
                dailyData[dateStr].activities.push({
                    name: activity.name,
                    type: activity.type,
                    distance: activity.distance / 1000
                });
            });
            
            // Chuyển đối tượng thành mảng
            const activityData = Object.values(dailyData);
            
            // Tính toán các thông số cho biểu đồ
            const cellSize = 40; // Kích thước ô
            const padding = 4; // Padding giữa các ô
            
            // Tính toán số tuần tối đa trong năm
            const numWeeks = 53; // Tối đa 53 tuần trong một năm
            
            // Kích thước SVG
            const width = (cellSize + padding) * 7 + 60; // 7 cột = 7 ngày trong tuần
            const height = (cellSize + padding) * numWeeks + 30; // Số hàng = số tuần + tiêu đề
            
            // Tạo SVG
            const svg = d3.select('#activityHeatmap')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Tạo nhóm để chứa biểu đồ
            const chart = svg.append('g')
                .attr('transform', `translate(50, 30)`);
            
            // Tạo các nhãn cho các ngày trong tuần
            const dayLabels = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            chart.selectAll('.day-label')
                .data(dayLabels)
                .enter()
                .append('text')
                .attr('class', 'day-label')
                .attr('x', (d, i) => (cellSize + padding) * i + cellSize / 2)
                .attr('y', -10)
                .text(d => d);
            
            // Tạo các nhãn cho các tháng
            const monthLabels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
            
            // Tính toán vị trí Y cho các tháng
            function getMonthPosition(month, year) {
                const firstDay = new Date(year, month, 1);
                const firstDayOfYear = new Date(year, 0, 1);
                const diff = firstDay - firstDayOfYear;
                const dayOfYear = Math.floor(diff / (24 * 60 * 60 * 1000)) + 1;
                const weekOfYear = Math.floor((dayOfYear + firstDayOfYear.getDay()) / 7);
                return weekOfYear;
            }
            
            // Thêm nhãn tháng
            monthLabels.forEach((month, i) => {
                const monthPosition = getMonthPosition(i, parseInt(year));
                chart.append('text')
                    .attr('class', 'month-label')
                    .attr('x', -40)
                    .attr('y', (cellSize + padding) * monthPosition + cellSize / 2)
                    .text(month);
            });
            
            // Tìm giá trị khoảng cách lớn nhất để chuẩn hóa kích thước vòng tròn
            const maxDistance = Math.max(...activityData.map(d => d.distance));
            
            // Tạo dữ liệu cho từng ngày trong năm
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(parseInt(year) + 1, 0, 0); // Ngày cuối cùng của năm
            
            const days = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                const dayData = dailyData[dateStr] || {
                    date: dateStr,
                    distance: 0,
                    activities: []
                };
                
                const dayOfWeek = currentDate.getDay(); // 0 = CN, 1 = T2, ..., 6 = T7
                const weekOfYear = Math.floor((dayOfDate(currentDate) + new Date(year, 0, 1).getDay()) / 7);
                
                days.push({
                    date: new Date(currentDate),
                    dateStr: dateStr,
                    dayOfWeek: dayOfWeek,
                    weekOfYear: weekOfYear,
                    distance: dayData.distance,
                    activities: dayData.activities
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Helper function để tính số ngày trong năm
            function dayOfDate(date) {
                const start = new Date(date.getFullYear(), 0, 0);
                const diff = date - start;
                return Math.floor(diff / (24 * 60 * 60 * 1000));
            }
            
            // Tạo tooltip
            const tooltip = d3.select('#activityHeatmap')
                .append('div')
                .attr('class', 'chart-tooltip')
                .style('opacity', 0);
            
            // Thêm vòng tròn cho mỗi ngày
            chart.selectAll('.day-circle')
                .data(days)
                .enter()
                .append('circle')
                .attr('class', 'day-circle')
                .attr('cx', d => (cellSize + padding) * d.dayOfWeek + cellSize / 2)
                .attr('cy', d => (cellSize + padding) * d.weekOfYear + cellSize / 2)
                .attr('r', d => d.distance > 0 ? Math.min(Math.sqrt(d.distance / maxDistance) * cellSize / 2, cellSize / 2 - 2) : 0)
                .attr('fill', d => {
                    if (d.distance === 0) return 'transparent';
                    // Màu sắc theo khoảng cách
                    if (d.distance < 5) return '#8dd3c7'; // Khoảng thấp
                    if (d.distance < 10) return '#fb8072'; // Khoảng trung bình
                    if (d.distance < 20) return '#80b1d3'; // Khoảng cao
                    return '#fc4c02'; // Khoảng rất cao (màu Strava)
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 1)
                .attr('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    if (d.distance > 0) {
                        d3.select(this).attr('stroke', '#000').attr('stroke-width', 2);
                        
                        let tooltipContent = `<strong>Ngày: ${new Date(d.date).toLocaleDateString('vi-VN')}</strong><br>`;
                        tooltipContent += `<strong>Tổng quãng đường: ${d.distance.toFixed(2)} km</strong><br>`;
                        
                        if (d.activities.length > 0) {
                            tooltipContent += '<strong>Hoạt động:</strong><br>';
                            d.activities.forEach(activity => {
                                tooltipContent += `- ${activity.name}: ${activity.distance.toFixed(2)} km (${activity.type})<br>`;
                            });
                        }
                        
                        tooltip.html(tooltipContent)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 15) + 'px')
                            .style('opacity', 1);
                    }
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke', '#fff').attr('stroke-width', 1);
                    tooltip.style('opacity', 0);
                });
                
            // Thêm nhãn khoảng cách vào các vòng tròn lớn
            chart.selectAll('.distance-label')
                .data(days.filter(d => d.distance >= 5)) // Chỉ hiển thị nhãn cho những ngày có quãng đường đủ lớn
                .enter()
                .append('text')
                .attr('class', 'distance-label')
                .attr('x', d => (cellSize + padding) * d.dayOfWeek + cellSize / 2)
                .attr('y', d => (cellSize + padding) * d.weekOfYear + cellSize / 2 + 4)
                .attr('text-anchor', 'middle')
                .attr('font-size', '9px')
                .attr('fill', '#fff')
                .text(d => d.distance.toFixed(1));
                
            // Thêm chú thích
            const legend = d3.select('#yearlyActivityChart')
                .append('div')
                .attr('class', 'legend');
                
            const legendItems = [
                { color: '#8dd3c7', label: '< 5 km' },
                { color: '#fb8072', label: '5-10 km' },
                { color: '#80b1d3', label: '10-20 km' },
                { color: '#fc4c02', label: '> 20 km' }
            ];
            
            legendItems.forEach(item => {
                const legendItem = legend.append('div')
                    .attr('class', 'legend-item');
                    
                legendItem.append('div')
                    .attr('class', 'legend-color')
                    .style('background-color', item.color);
                    
                legendItem.append('span')
                    .text(item.label);
            });
