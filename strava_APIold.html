<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lấy dữ liệu GPS từ Strava</title>
    <!-- Thêm thư viện Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <!-- Thêm thư viện d3.js cho đồ thị -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        h1 {
            color: #FC4C02;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            background-color: #FC4C02;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .btn:hover {
            background-color: #E34402;
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #activityList {
            margin-top: 20px;
        }
        
        .activity-item {
            background-color: white;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .activity-item h3 {
            margin-top: 0;
            color: #FC4C02;
        }
        
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .error {
            background-color: #ffeeee;
            color: #d32f2f;
        }
        
        .success {
            background-color: #eeffee;
            color: #388e3c;
        }
        
        .hidden {
            display: none;
        }
        
        /* Thêm kiểu cho bản đồ */
        .map-container {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 400px;
            width: 100%;
        }
        
        .activity-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .activity-info-item {
            flex: 1 0 30%;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Thêm style cho đồ thị heat map */
        #yearHeatMap {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .heatmap-container {
            font-family: Arial, sans-serif;
            margin: 20px 0;
        }
        
        .heatmap-title {
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: auto repeat(52, minmax(20px, 1fr));
            gap: 2px;
        }
        
        .heatmap-label {
            text-align: right;
            padding-right: 10px;
            font-size: 12px;
            align-self: center;
        }
        
        .heatmap-week-label {
            text-align: center;
            font-size: 10px;
            padding: 5px 0;
        }
        
        .heatmap-month-divider {
            border-left: 1px solid #ddd;
            position: relative;
        }
        
        .heatmap-month-label {
            position: absolute;
            top: -20px;
            width: 30px;
            text-align: center;
            font-size: 10px;
            left: -15px;
        }
        
        .heatmap-cell {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: white;
            text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.7);
        }
        
        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .heatmap-stats {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .heatmap-summary {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .heatmap-summary-item {
            flex: 1 0 25%;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .heatmap-summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #FC4C02;
        }
        
        .heatmap-summary-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Lấy dữ liệu GPS từ Strava</h1>
    
    <div class="container">
        <p>Ứng dụng này cho phép bạn kết nối với tài khoản Strava của mình và tải về dữ liệu GPS từ các hoạt động của bạn.</p>
        
        <div id="statusMessage" class="status hidden"></div>
        
        <div id="authSection">
            <p>Bước 1: Kết nối với tài khoản Strava của bạn.</p>
            <button id="authorizeBtn" class="btn">Kết nối với Strava</button>
        </div>
        
        <div id="activitiesSection" class="hidden">
            <p>Bước 2: Lấy danh sách hoạt động gần đây của bạn.</p>
            <button id="getActivitiesBtn" class="btn">Lấy danh sách hoạt động</button>
            <button id="getYearlyStatsBtn" class="btn">Thống kê 52 tuần</button>
            
            <div id="activityList"></div>
        </div>
        
        <div id="yearStatsSection" class="hidden">
            <h3>Thống kê luyện tập 52 tuần gần nhất</h3>
            
            <div id="yearHeatMap"></div>
            
            <div class="heatmap-stats">
                <h4>Tổng kết</h4>
                <div class="heatmap-summary" id="heatmapSummary">
                    <!-- Sẽ được điền bởi JavaScript -->
                </div>
            </div>
            
            <button id="backToListFromStatsBtn" class="btn" style="margin-top: 20px;">Quay lại danh sách</button>
        </div>
        
        <div id="activityDetailSection" class="hidden">
            <div id="activityDetailContainer"></div>
            
            <div class="tabs">
                <div class="tab active" data-tab="map">Bản đồ</div>
                <div class="tab" data-tab="details">Chi tiết</div>
                <div class="tab" data-tab="raw">Dữ liệu</div>
            </div>
            
            <div class="tab-content active" id="mapTab">
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="tab-content" id="detailsTab">
                <div id="activityStats"></div>
            </div>
            
            <div class="tab-content" id="rawTab">
                <div id="activityRawData"></div>
            </div>
            
            <button id="backToListBtn" class="btn" style="margin-top: 20px;">Quay lại danh sách</button>
        </div>
    </div>
    
    <script>
        // Cấu hình ứng dụng Strava
        const clientId = '55949'; // Thay thế bằng Client ID của bạn từ Strava API
        const redirectUri = "https://quantrh.github.io/quan-ly-quy-com/strava_APIold.html";
        
        // Các phần tử DOM
        const authorizeBtn = document.getElementById('authorizeBtn');
        const getActivitiesBtn = document.getElementById('getActivitiesBtn');
        const getYearlyStatsBtn = document.getElementById('getYearlyStatsBtn');
        const activityList = document.getElementById('activityList');
        const authSection = document.getElementById('authSection');
        const activitiesSection = document.getElementById('activitiesSection');
        const yearStatsSection = document.getElementById('yearStatsSection');
        const activityDetailSection = document.getElementById('activityDetailSection');
        const activityDetailContainer = document.getElementById('activityDetailContainer');
        const activityStats = document.getElementById('activityStats');
        const activityRawData = document.getElementById('activityRawData');
        const backToListBtn = document.getElementById('backToListBtn');
        const backToListFromStatsBtn = document.getElementById('backToListFromStatsBtn');
        const yearHeatMap = document.getElementById('yearHeatMap');
        const statusMessage = document.getElementById('statusMessage');
        
        // Biến lưu trữ
        let accessToken = null;
        let map = null;
        let currentActivityData = null;
        let yearlyActivities = [];
        
        // Xử lý khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra nếu có mã xác thực từ Strava sau khi redirect
            const urlParams = new URLSearchParams(window.location.search);
            const authorizationCode = urlParams.get('code');
            
            if (authorizationCode) {
                // Đã nhận được mã xác thực, tiến hành lấy access token
                showStatus('Đang xác thực với Strava...', 'success');
                exchangeCodeForToken(authorizationCode);
            }
            
            // Thiết lập sự kiện tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Xóa lớp active từ tất cả các tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Thêm lớp active vào tab được nhấp
                    this.classList.add('active');
                    
                    // Hiển thị nội dung tab tương ứng
                    const tabId = this.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Thiết lập sự kiện nút quay lại
            backToListBtn.addEventListener('click', function() {
                activityDetailSection.classList.add('hidden');
                activitiesSection.classList.remove('hidden');
            });
            
            backToListFromStatsBtn.addEventListener('click', function() {
                yearStatsSection.classList.add('hidden');
                activitiesSection.classList.remove('hidden');
            });
            
            // Thiết lập sự kiện lấy thống kê năm
            getYearlyStatsBtn.addEventListener('click', function() {
                if (accessToken) {
                    getYearlyActivities();
                } else {
                    showStatus('Vui lòng kết nối với Strava trước', 'error');
                }
            });
        });
        
        // Sự kiện nút kết nối với Strava
        authorizeBtn.addEventListener('click', function() {
            const scope = 'read,activity:read';
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}`;
            window.location.href = authUrl;
        });
        
        // Sự kiện nút lấy danh sách hoạt động
        getActivitiesBtn.addEventListener('click', function() {
            if (accessToken) {
                getActivities();
            } else {
                showStatus('Vui lòng kết nối với Strava trước', 'error');
            }
        });
        
        // Trao đổi mã xác thực lấy access token
        function exchangeCodeForToken(code) {
            const tokenUrl = 'https://www.strava.com/oauth/token';
            const data = {
                client_id: clientId,
                client_secret: 'c710bdd65acd66b7ce99db734e9850f04bb5ad83', // Thay thế bằng Client Secret của bạn
                code: code,
                grant_type: 'authorization_code'
            };
            
            fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(tokenData => {
                accessToken = tokenData.access_token;
                showStatus('Đã kết nối thành công với Strava!', 'success');
                
                // Hiển thị phần lấy hoạt động
                authSection.classList.add('hidden');
                activitiesSection.classList.remove('hidden');
            })
            .catch(error => {
                showStatus('Lỗi khi xác thực: ' + error.message, 'error');
                console.error('Error exchanging token:', error);
            });
        }
        
        // Lấy danh sách hoạt động
        function getActivities() {
            showStatus('Đang tải danh sách hoạt động...', 'success');
            
            fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(activities => {
                showStatus('Đã tải danh sách hoạt động thành công!', 'success');
                displayActivities(activities);
            })
            .catch(error => {
                showStatus('Lỗi khi tải hoạt động: ' + error.message, 'error');
                console.error('Error fetching activities:', error);
            });
        }
        
        // Hiển thị danh sách hoạt động
        function displayActivities(activities) {
            activityList.innerHTML = '';
            
            if (activities.length === 0) {
                activityList.innerHTML = '<p>Không tìm thấy hoạt động nào.</p>';
                return;
            }
            
            activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const date = new Date(activity.start_date).toLocaleDateString('vi-VN');
                
                activityItem.innerHTML = `
                    <h3>${activity.name}</h3>
                    <div class="activity-info">
                        <div class="activity-info-item">
                            <strong>Ngày:</strong> ${date}
                        </div>
                        <div class="activity-info-item">
                            <strong>Loại:</strong> ${activity.type}
                        </div>
                        <div class="activity-info-item">
                            <strong>Quãng đường:</strong> ${(activity.distance / 1000).toFixed(2)} km
                        </div>
                        <div class="activity-info-item">
                            <strong>Thời gian:</strong> ${formatDuration(activity.moving_time)}
                        </div>
                        <div class="activity-info-item">
                            <strong>Tốc độ trung bình:</strong> ${(activity.average_speed * 3.6).toFixed(2)} km/h
                        </div>
                    </div>
                    <button class="btn view-map" data-id="${activity.id}">Xem bản đồ</button>
                    <button class="btn download-gpx" data-id="${activity.id}">Tải GPX</button>
                `;
                
                activityList.appendChild(activityItem);
            });
            
            // Thêm sự kiện cho các nút xem bản đồ
            document.querySelectorAll('.view-map').forEach(button => {
                button.addEventListener('click', function() {
                    const activityId = this.getAttribute('data-id');
                    viewActivityMap(activityId);
                });
            });
            
            // Thêm sự kiện cho các nút tải GPX
            document.querySelectorAll('.download-gpx').forEach(button => {
                button.addEventListener('click', function() {
                    const activityId = this.getAttribute('data-id');
                    downloadGpx(activityId);
                });
            });
        }
        
        // Lấy hoạt động của cả năm (52 tuần)
        function getYearlyActivities() {
            showStatus('Đang tải dữ liệu hoạt động 52 tuần...', 'success');
            
            const now = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(now.getFullYear() - 1);
            
            // Chuyển đổi sang timestamp (seconds) cho Strava API
            const after = Math.floor(oneYearAgo.getTime() / 1000);
            
            // Lấy tất cả hoạt động trong 1 năm qua, tối đa 200 hoạt động
            fetch(`https://www.strava.com/api/v3/athlete/activities?after=${after}&per_page=200`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(activities => {
                // Lọc chỉ các hoạt động chạy bộ
                const runActivities = activities.filter(activity => 
                    activity.type === 'Run' || 
                    activity.type === 'TrailRun' || 
                    activity.type === 'VirtualRun'
                );
                
                yearlyActivities = runActivities;
                
                // Hiển thị biểu đồ heat map
                renderHeatMap(yearlyActivities);
                
                // Hiển thị phần thống kê năm
                activitiesSection.classList.add('hidden');
                yearStatsSection.classList.remove('hidden');
                
                showStatus('Đã tải dữ liệu 52 tuần thành công!', 'success');
            })
            .catch(error => {
                showStatus('Lỗi khi tải dữ liệu 52 tuần: ' + error.message, 'error');
                console.error('Error fetching yearly activities:', error);
            });
        }
        
        // Tạo heat map cho hoạt động trong năm
        function renderHeatMap(activities) {
            // Tạo bố cục base cho heat map
            yearHeatMap.innerHTML = '';
            
            const heatmapContainer = document.createElement('div');
            heatmapContainer.className = 'heatmap-container';
            
            const heatmapTitle = document.createElement('div');
            heatmapTitle.className = 'heatmap-title';
            heatmapTitle.textContent = 'Heat Map Hoạt Động Chạy Bộ - 52 Tuần Gần Đây';
            
            const heatmapGrid = document.createElement('div');
            heatmapGrid.className = 'heatmap-grid';
            
            // Tạo dữ liệu cho grid
            // Lấy thời gian hiện tại
            const today = new Date();
            const weekdays = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'CN'];
            
            // Tạo các nhãn hàng (ngày trong tuần)
            heatmapGrid.innerHTML = '<div></div>'; // Ô trống ở góc trên bên trái
            
            // Tạo các nhãn tuần (52 tuần)
            for (let week = 0; week < 52; week++) {
                const weekLabel = document.createElement('div');
                weekLabel.className = 'heatmap-week-label';
                
                // Chỉ hiển thị nhãn cho mỗi 4 tuần
                if (week % 4 === 0) {
                    weekLabel.textContent = week + 1;
                }
                
                heatmapGrid.appendChild(weekLabel);
            }
            
            // Chuẩn bị dữ liệu hoạt động theo ngày
            const activityByDate = {};
            activities.forEach(activity => {
                const date = new Date(activity.start_date).toISOString().split('T')[0];
                if (!activityByDate[date]) {
                    activityByDate[date] = {
                        distance: 0,
                        count: 0
                    };
                }
                activityByDate[date].distance += activity.distance / 1000; // Chuyển đổi sang km
                activityByDate[date].count += 1;
            });
            
            // Tìm giá trị distance lớn nhất cho thang màu
            let maxDistance = 0;
            Object.values(activityByDate).forEach(day => {
                if (day.distance > maxDistance) {
                    maxDistance = day.distance;
                }
            });
            
            // Tạo một bảng màu (từ xanh nhạt đến xanh đậm)
            const colorScale = (value) => {
                // Nếu không có giá trị, trả về màu trong suốt
                if (value === 0) return 'transparent';
                
                // Tạo thang màu từ xanh nhạt đến xanh đậm
                const intensity = Math.min(0.2 + (value / maxDistance) * 0.8, 1);
                return `rgba(0, 122, 255, ${intensity})`;
            };
            
            // Tạo các hàng cho mỗi ngày trong tuần
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                // Thêm nhãn ngày trong tuần
                const dayLabel = document.createElement('div');
                dayLabel.className = 'heatmap-label';
                dayLabel.textContent = weekdays[dayIndex];
                heatmapGrid.appendChild(dayLabel);
                
                // Tạo cells cho mỗi tuần
                for (let week = 0; week < 52; week++) {
                    // Tính ngày dựa trên tuần hiện tại và ngày trong tuần
                    const cellDate = new Date(today);
                    cellDate.setDate(today.getDate() - ((today.getDay() || 7) - 1) - (51 - week) * 7 - (6 - dayIndex));
                    
                    const dateStr = cellDate.toISOString().split('T')[0];
                    const dayData = activityByDate[dateStr] || { distance: 0, count: 0 };
                    
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    
                    // Đặt kích thước dựa trên khoảng cách chạy
                    const distance = dayData.distance;
                    
                    if (distance > 0) {
                        // Tính kích thước dựa trên khoảng cách (tối thiểu 8px, tối đa 20px)
                        const size = 8 + Math.min(distance / maxDistance * 12, 12);
                        cell.style.width = `${size}px`;
                        cell.style.height = `${size}px`;
                        cell.style.backgroundColor = colorScale(distance);
                        
                        // Hiển thị số km trong cell
                        cell.textContent = distance.toFixed(1);
                        
                        // Thêm thông tin chi tiết khi hover
                        const formattedDate = cellDate.toLocaleDateString('vi-VN');
                        cell.title = `${formattedDate}: ${distance.toFixed(2)} km (${dayData.count} hoạt động)`;
                    }
                    
                    heatmapGrid.appendChild(cell);
                }
            }
            
            // Tạo legend
            const legend = document.createElement('div');
            legend.className = 'legend';
            
            // Tạo các mức cho legend
            const legendLevels = [1, 3, 5, 10, 15];
            legendLevels.forEach(level => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const legendColor = document.createElement('div');
                legendColor.className = 'legend-color';
                legendColor.style.backgroundColor = colorScale(level / legendLevels[legendLevels.length - 1] * maxDistance);
                
                const legendLabel = document.createElement('span');
                legendLabel.textContent = `${level} km`;
                
                legendItem.appendChild(legendColor);
                legendItem.appendChild(legendLabel);
                legend.appendChild(legendItem);
            });
            
            // Thêm tất cả vào container
            heatmapContainer.appendChild(heatmapTitle);
            heatmapContainer.appendChild(heatmapGrid);
            heatmapContainer.appendChild(legend);
            yearHeatMap.appendChild(heatmapContainer);
            
            // Tạo tổng kết
            createHeatmapSummary(activities);
        }
        
        // Tạo tổng kết cho heat map
        function createHeatmapSummary(activities) {
            const heatmapSummary = document.getElementById('heatmapSummary');
            heatmapSummary.innerHTML = '';
            
            // Tính toán tổng kết
            const totalRuns = activities.length;
            let totalDistance = 0;
            let totalElevation = 0;
            let totalTime = 0;
            
            activities.forEach(activity => {
                totalDistance += activity.distance / 1000; // km
                totalElevation += activity.total_elevation_gain || 0; // m
                totalTime += activity.moving_time || 0; // seconds
            });
            
            // Tạo mảng các ngày hoạt động
            const activeDays = new Set();
            activities.forEach(activity
